<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AquaIA - Sistema Completo de An√°lise de √Ågua</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 10px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.95;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .wide-card {
            grid-column: 1 / -1;
        }

        .card {
            background: rgba(255, 255, 255, 0.97);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

        .card h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        .card-icon {
            font-size: 1.8rem;
            margin-right: 10px;
        }

        .edit-controls {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .btn-small:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .btn-small.danger {
            background: linear-gradient(135deg, #f44336, #d32f2f);
        }

        .btn-small.success {
            background: linear-gradient(135deg, #4caf50, #388e3c);
        }

        .btn-small.info {
            background: linear-gradient(135deg, #2196f3, #1976d2);
        }

        /* Se√ß√£o de Dados do Cliente */
        .client-data {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .client-field {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }

        .client-field label {
            font-weight: bold;
            color: #555;
            font-size: 0.9rem;
            display: block;
            margin-bottom: 5px;
        }

        .client-field .value {
            color: #333;
            font-size: 1.1rem;
            font-weight: 500;
        }

        /* Se√ß√£o de Leituras */
        .readings-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .reading-item {
            text-align: center;
            background: linear-gradient(135deg, #f8f9ff, #e8f4fd);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #e0e8ff;
        }

        .reading-value {
            font-size: 2.2rem;
            font-weight: bold;
            color: #667eea;
            display: block;
        }

        .reading-label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }

        /* Se√ß√£o de Consumo */
        .consumption-display {
            text-align: center;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 30px;
            border-radius: 20px;
            margin: 20px 0;
        }

        .consumption-value {
            font-size: 4rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .consumption-unit {
            font-size: 1.4rem;
            opacity: 0.9;
        }

        .consumption-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .detail-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .detail-value {
            font-size: 1.3rem;
            font-weight: bold;
        }

        .detail-label {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 5px;
        }

        /* Hist√≥rico de Consumo */
        .consumption-history {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .history-table th,
        .history-table td {
            padding: 12px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }

        .history-table th {
            background: #667eea;
            color: white;
            font-weight: bold;
        }

        .history-table tr:nth-child(even) {
            background: rgba(102, 126, 234, 0.05);
        }

        .history-table tr:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        /* Se√ß√£o de Valores */
        .billing-section {
            display: grid;
            gap: 15px;
        }

        .billing-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .billing-item.total {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
            border-left: 4px solid #fff;
        }

        .billing-label {
            font-weight: 600;
        }

        .billing-value {
            font-weight: bold;
            color: #667eea;
        }

        .billing-item.total .billing-value {
            color: white;
        }

        /* Gr√°fico de Consumo */
        .consumption-chart {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            min-height: 300px;
        }

        .chart-container {
            display: flex;
            align-items: end;
            height: 200px;
            gap: 15px;
            margin: 20px 0;
            padding: 0 10px;
        }

        .bar {
            background: linear-gradient(to top, #667eea, #764ba2);
            border-radius: 8px 8px 0 0;
            min-width: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: end;
            color: white;
            font-size: 0.8rem;
            position: relative;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .bar:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        .bar-value {
            padding: 5px;
            font-weight: bold;
        }

        .bar-label {
            position: absolute;
            bottom: -25px;
            color: #333;
            font-size: 0.7rem;
            font-weight: bold;
        }

        /* Informa√ß√µes da Concession√°ria */
        .company-info {
            background: linear-gradient(135deg, #f8f9ff, #e8f4fd);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #e0e8ff;
        }

        .company-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .company-field {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        /* Se√ß√£o de Tarifas */
        .tariff-section {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .tariff-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .tariff-table th,
        .tariff-table td {
            padding: 12px;
            text-align: left;
            border: 1px solid #e0e0e0;
        }

        .tariff-table th {
            background: #667eea;
            color: white;
        }

        /* Se√ß√£o de Qualidade da √Ågua */
        .water-quality {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .quality-item {
            text-align: center;
            background: #f8f9ff;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #e0e8ff;
        }

        .quality-status {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            font-weight: bold;
        }

        .status-good {
            background: linear-gradient(135deg, #4caf50, #388e3c);
        }

        .status-warning {
            background: linear-gradient(135deg, #ff9800, #f57c00);
        }

        .status-danger {
            background: linear-gradient(135deg, #f44336, #d32f2f);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close:hover {
            color: #667eea;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn-modal-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .btn.clear {
            background: linear-gradient(135deg, #f44336, #d32f2f);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        /* Alertas */
        .alert {
            padding: 15px 20px;
            margin: 15px 0;
            border-radius: 10px;
            font-weight: 500;
            border-left: 5px solid;
        }

        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
            border-left-color: #ffc107;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border-left-color: #28a745;
        }

        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border-left-color: #17a2b8;
        }

        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border-left-color: #dc3545;
        }

        /* Recomenda√ß√µes da IA */
        .recommendations {
            background: rgba(255, 255, 255, 0.97);
            border-radius: 20px;
            padding: 30px;
            margin-top: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }

        .recommendation-item {
            background: linear-gradient(135deg, #f8f9ff, #e8f4fd);
            border-left: 5px solid #667eea;
            padding: 20px;
            margin: 15px 0;
            border-radius: 0 15px 15px 0;
            transition: transform 0.3s ease;
        }

        .recommendation-item:hover {
            transform: translateX(5px);
        }

        .recommendation-item h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .recommendation-meta {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .meta-item {
            background: rgba(102, 126, 234, 0.1);
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .client-data {
                grid-template-columns: 1fr;
            }
            
            .consumption-details {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><span class="card-icon">üíß</span>AquaIA<span class="card-icon">ü§ñ</span></h1>
            <p>Sistema Inteligente de An√°lise Completa de Conta de √Ågua - √Åguas de Manaus</p>
        </div>

        <div class="card wide-card">
            <h3><span class="card-icon">üè¢</span>Informa√ß√µes da Concession√°ria
                <div class="edit-controls">
                    <button class="btn-small" onclick="editCompanyInfo()">Editar</button>
                </div>
            </h3>
            <div class="company-info">
                <div class="company-details" id="company-info">
                    </div>
            </div>
        </div>

        <div class="dashboard">
            <div class="card">
                <h3><span class="card-icon">üë§</span>Dados do Cliente
                    <div class="edit-controls">
                        <button class="btn-small" onclick="editClient()">Editar</button>
                        <button class="btn-small info" onclick="viewFullAddress()">Ver Completo</button>
                    </div>
                </h3>
                <div class="client-data" id="client-data">
                    </div>
            </div>

            <div class="card">
                <h3><span class="card-icon">üìÑ</span>Informa√ß√µes da Fatura
                    <div class="edit-controls">
                        <button class="btn-small" onclick="editInvoice()">Editar</button>
                        <button class="btn-small success" onclick="downloadPDF()">PDF</button>
                    </div>
                </h3>
                <div class="client-data" id="invoice-data">
                    </div>
            </div>

            <div class="card">
                <h3><span class="card-icon">üìä</span>Leituras do Hidr√¥metro
                    <div class="edit-controls">
                        <button class="btn-small" onclick="editReadings()">Editar</button>
                    </div>
                </h3>
                <div class="readings-section" id="readings-section">
                    </div>
            </div>

            <div class="card">
                <h3><span class="card-icon">üíß</span>An√°lise de Consumo
                    <div class="edit-controls">
                        <button class="btn-small" onclick="editConsumption()">Editar</button>
                    </div>
                </h3>
                <div class="consumption-display">
                    <div class="consumption-value" id="monthlyConsumption">31</div>
                    <div class="consumption-unit">m¬≥ consumidos</div>
                    <div class="consumption-details" id="consumption-details">
                        </div>
                </div>
            </div>

            <div class="card">
                <h3><span class="card-icon">üí∞</span>Discrimina√ß√£o de Valores
                    <div class="edit-controls">
                        <button class="btn-small" onclick="editBilling()">Editar</button>
                    </div>
                </h3>
                <div class="billing-section" id="billing-section">
                    </div>
            </div>

            <div class="card">
                <h3><span class="card-icon">üß™</span>Qualidade da √Ågua
                    <button class="btn-small" onclick="editWaterQuality()">Editar</button>
                </h3>
                <div class="water-quality" id="water-quality">
                    </div>
            </div>
        </div>

        <div class="card wide-card">
            <h3><span class="card-icon">üìà</span>Hist√≥rico de Consumo dos √öltimos Meses</h3>
            <div class="consumption-history">
                <div class="consumption-chart">
                    <div class="chart-container" id="consumption-chart">
                        </div>
                </div>
                <table class="history-table" id="history-table">
                    </table>
            </div>
        </div>

        <div class="card wide-card">
            <h3><span class="card-icon">üí≤</span>Estrutura Tarif√°ria</h3>
            <div class="tariff-section">
                <p><strong>Categoria:</strong> <span id="tariff-category">Residencial</span></p>
                <table class="tariff-table" id="tariff-table">
                    </table>
            </div>
        </div>

        <div class="card wide-card">
            <h3><span class="card-icon">‚öôÔ∏è</span>Controles e Ferramentas</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <button class="btn-small" onclick="addNewInvoice()">‚ûï Nova Fatura</button>
                <button class="btn-small" onclick="compareConsumption()">üìä Comparar</button>
                <button class="btn-small" onclick="generateReport()">üìã Relat√≥rio</button>
                <button class="btn-small" onclick="exportData()">üì§ Exportar</button>
                <button class="btn-small" onclick="importData()">üì• Importar</button>
                <button class="btn-small" onclick="undoLastAction()">‚Ü∂ Desfazer</button>
                <button class="btn-small danger" onclick="resetSystem()">üóëÔ∏è Reset</button>
                <button class="btn-small info" onclick="showHelp()">‚ùì Ajuda</button>
            </div>
        </div>

        <div class="recommendations">
            <h3><span class="card-icon">ü§ñ</span>An√°lise Inteligente e Recomenda√ß√µes</h3>
            <div id="ai-recommendations">
                </div>
        </div>

        <div id="alerts-container">
            </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3 id="modal-title">Editar Dados</h3>
            <div id="edit-form">
                </div>
            <div class="btn-modal-group">
                <button class="btn clear" onclick="clearFields()">Limpar</button>
                <button class="btn" onclick="saveChanges()">üíæ Corrigir</button>
            </div>
        </div>
    </div>

    <script>
        // Dados completos da fatura (baseados na imagem)
        let currentInvoiceData = {
            // Dados da Concession√°ria
            companyInfo: {
                nome: "√ÅGUAS DE MANAUS S/A",
                endereco: "RUA DO BOMBEAMENTO, 01, COMPENSA",
                cidade: "MANAUS/AM",
                cep: "69029-160",
                cnpj: "03.764.977/0001-27",
                inscricaoEstadual: "04.141.933-5"
            },
            
            // Dados do Cliente
            cliente: {
                nome: "ARNOLD SOUZA DE LIMA",
                matricula: "4239385-0",
                endereco: "RUA DIVINOPOLIS - 50, TERRA NOVA - LOT. RIO PIORINI - MANAUS",
                cep: "69095001",
                categoria: "RESIDENCIAL",
                tarifa: "RESIDENCIAL",
                situacao: "ATIVA"
            },
            
            // Dados da Fatura
            fatura: {
                numero: "2110931",
                referencia: "08/2025",
                dataEmissao: "14/08/2025",
                dataVencimento: "02/09/2025",
                roteirizacao: "010 015 027 0076 000"
            },
            
            // Dados do Hidr√¥metro
            hidrometro: {
                numero: "Y24562582350",
                leituraAnterior: 994,
                leituraAtual: 1025,
                consumo: 31,
                diasConsumo: 30,
                multiplicador: 1
            },
            
            // Hist√≥rico de Consumo
            historico: [
                { mes: "07-2024", consumo: 1103, valor: 0 },
                { mes: "08-2024", consumo: 1103, valor: 0 },
                { mes: "09-2024", consumo: 53, valor: 1652 },
                { mes: "10-2024", consumo: 1652, valor: 1653 },
                { mes: "11-2024", consumo: 1653, valor: 1109 },
                { mes: "12-2024", consumo: 1109, valor: 1632 },
                { mes: "01-2025", consumo: 1632, valor: 1653 },
                { mes: "02-2025", consumo: 1653, valor: 1025 }
            ],
            
            // Valores da Fatura
            valores: {
                valorAgua: 250.59,
                jrs: 4.63,
                parc: 2.17,
                parcIrreg: 483.87,
                parcDeb: 29.69,
                totalPagar: 770.95
            },
            
            // Faixas de Consumo
            faixasConsumo: [
                { faixa: "0 a 10", consumo: 10, tarifa: "148.148" },
                { faixa: "10 a 20", consumo: 10, tarifa: "197.163" },
                { faixa: "20 a 30", consumo: 11, tarifa: "271.96" }
            ],
            
            // Qualidade da √Ågua
            qualidade: {
                ph: { valor: 7.2, status: "good", label: "pH" },
                cloro: { valor: 0.8, status: "good", label: "Cloro (mg/L)" },
                turbidez: { valor: 0.5, status: "good", label: "Turbidez (NTU)" },
                coliformes: { valor: 0, status: "good", label: "Coliformes" }
            }
        };

        // Hist√≥rico de faturas
        let invoiceHistory = [currentInvoiceData];
        let actionHistory = [];

        // Sistema de IA avan√ßado
        class AdvancedWaterAI {
            analyzeCompleteData(data) {
                const recommendations = [];
                const alerts = [];
                
                // An√°lise de consumo
                const consumo = data.hidrometro.consumo;
                const valorTotal = data.valores.totalPagar;
                const mediaHistorica = this.calculateHistoricalAverage(data.historico);
                
                // Detec√ß√£o de anomalias
                if (consumo > mediaHistorica * 2) {
                    alerts.push({
                        type: 'danger',
                        message: `üö® Consumo an√¥malo detectado! ${consumo}m¬≥ √© ${((consumo/mediaHistorica - 1) * 100).toFixed(0)}% acima da m√©dia hist√≥rica.`
                    });
                }
                
                // An√°lise de tend√™ncia
                const tendencia = this.analyzeTrend(data.historico);
                if (tendencia === 'crescente') {
                    alerts.push({
                        type: 'warning',
                        message: 'üìà Tend√™ncia de aumento no consumo detectada nos √∫ltimos meses.'
                    });
                }
                
                // An√°lise financeira
                if (valorTotal > 500) {
                    recommendations.push({
                        category: 'üí∞ Economia Financeira',
                        title: 'Fatura elevada detectada',
                        description: `Sua fatura de R$ ${valorTotal.toFixed(2)} est√° acima da m√©dia. Considere implementar medidas de economia urgentes.`,
                        impact: 'Alto',
                        savings: 'At√© R$ 300/m√™s',
                        priority: 'Alta'
                    });
                }
                
                // An√°lise de vazamentos
                if (consumo > 0 && data.hidrometro.diasConsumo > 0) {
                    const consumoDiario = consumo / data.hidrometro.diasConsumo;
                    if (consumoDiario > 2) {
                        recommendations.push({
                            category: 'üîß Manuten√ß√£o',
                            title: 'Poss√≠vel vazamento detectado',
                            description: `Consumo di√°rio de ${consumoDiario.toFixed(1)}m¬≥ pode indicar vazamentos. Verifique torneiras, vasos sanit√°rios e tubula√ß√µes.`,
                            impact: 'Muito Alto',
                            savings: 'R$ 100-500/m√™s',
                            priority: 'Urgente'
                        });
                    }
                }
                
                // Recomenda√ß√µes gerais baseadas no consumo
                if (consumo > 20) {
                    recommendations.push({
                        category: 'üíß Conserva√ß√£o',
                        title: 'Implementar medidas de economia',
                        description: 'Instale dispositivos economizadores como aeradores, v√°lvulas de duplo acionamento e chuveiros econ√¥micos.',
                        impact: 'M√©dio',
                        savings: 'R$ 80-200/m√™s',
                        priority: 'M√©dia'
                    });
                }
                
                // An√°lise sazonal
                const mesAtual = new Date().getMonth();
                if (mesAtual >= 5 && mesAtual <= 8) { // Jun-Set (seco)
                    recommendations.push({
                        category: 'üå± Sustentabilidade',
                        title: 'Economia durante per√≠odo seco',
                        description: 'Aproveite √°gua da chuva, reutilize √°gua de lavagem e regue plantas pela manh√£.',
                        impact: 'M√©dio',
                        savings: 'R$ 50-120/m√™s',
                        priority: 'M√©dia'
                    });
                }
                
                // Alertas de qualidade
                const qualidade = data.qualidade;
                Object.keys(qualidade).forEach(param => {
                    if (qualidade[param].status !== 'good') {
                        alerts.push({
                            type: 'warning',
                            message: `‚ö†Ô∏è Par√¢metro ${qualidade[param].label} fora do ideal: ${qualidade[param].valor}`
                        });
                    }
                });
                
                return { recommendations, alerts };
            }
            
            calculateHistoricalAverage(historico) {
                if (!historico || historico.length === 0) return 25;
                const validConsumptions = historico.filter(h => h.consumo > 0 && h.consumo < 1000);
                if (validConsumptions.length === 0) return 25;
                return validConsumptions.reduce((sum, h) => sum + h.consumo, 0) / validConsumptions.length;
            }
            
            analyzeTrend(historico) {
                if (!historico || historico.length < 3) return 'est√°vel';
                const recent = historico.slice(-3).map(h => h.consumo).filter(c => c > 0 && c < 1000);
                if (recent.length < 3) return 'est√°vel';
                
                const trend = (recent[2] - recent[0]) / recent[0];
                if (trend > 0.2) return 'crescente';
                if (trend < -0.2) return 'decrescente';
                return 'est√°vel';
            }
            
            generateWaterTips(consumo) {
                const tips = [
                    "üí° Feche a torneira ao escovar os dentes - economize at√© 12L por escova√ß√£o",
                    "üöø Reduza o tempo de banho para 5 minutos - economize at√© 100L por banho",
                    "üßΩ Use balde para lavar o carro em vez de mangueira - economize at√© 300L",
                    "üå± Regue plantas pela manh√£ ou fim da tarde para evitar evapora√ß√£o",
                    "üîß Conserte vazamentos imediatamente - uma torneira pingando gasta 45L/dia",
                    "‚ôªÔ∏è Reutilize √°gua da m√°quina de lavar para limpeza geral",
                    "üè† Instale v√°lvulas de duplo acionamento nos vasos sanit√°rios",
                    "üíß Use aeradores nas torneiras para reduzir vaz√£o sem perder press√£o"
                ];
                
                const relevantTips = consumo > 30 ? tips : tips.slice(0, 4);
                return relevantTips.sort(() => 0.5 - Math.random()).slice(0, 3);
            }
        }

        const waterAI = new AdvancedWaterAI();

        // Fun√ß√µes de exibi√ß√£o
        function displayCompanyInfo() {
            const container = document.getElementById('company-info');
            const info = currentInvoiceData.companyInfo;
            
            container.innerHTML = `
                <div class="company-field">
                    <label>Concession√°ria:</label>
                    <div class="value">${info.nome}</div>
                </div>
                <div class="company-field">
                    <label>Endere√ßo:</label>
                    <div class="value">${info.endereco}</div>
                </div>
                <div class="company-field">
                    <label>Cidade:</label>
                    <div class="value">${info.cidade}</div>
                </div>
                <div class="company-field">
                    <label>CEP:</label>
                    <div class="value">${info.cep}</div>
                </div>
                <div class="company-field">
                    <label>CNPJ:</label>
                    <div class="value">${info.cnpj}</div>
                </div>
                <div class="company-field">
                    <label>Inscri√ß√£o Estadual:</label>
                    <div class="value">${info.inscricaoEstadual}</div>
                </div>
            `;
        }

        function displayClientData() {
            const container = document.getElementById('client-data');
            const client = currentInvoiceData.cliente;
            
            container.innerHTML = `
                <div class="client-field">
                    <label>Nome do Cliente:</label>
                    <div class="value">${client.nome}</div>
                </div>
                <div class="client-field">
                    <label>Matr√≠cula:</label>
                    <div class="value">${client.matricula}</div>
                </div>
                <div class="client-field">
                    <label>Endere√ßo:</label>
                    <div class="value">${client.endereco}</div>
                </div>
                <div class="client-field">
                    <label>CEP:</label>
                    <div class="value">${client.cep}</div>
                </div>
                <div class="client-field">
                    <label>Categoria:</label>
                    <div class="value">${client.categoria}</div>
                </div>
                <div class="client-field">
                    <label>Situa√ß√£o:</label>
                    <div class="value">${client.situacao}</div>
                </div>
            `;
        }

        function displayInvoiceData() {
            const container = document.getElementById('invoice-data');
            const invoice = currentInvoiceData.fatura;
            
            container.innerHTML = `
                <div class="client-field">
                    <label>N√∫mero da Fatura:</label>
                    <div class="value">${invoice.numero}</div>
                </div>
                <div class="client-field">
                    <label>M√™s Refer√™ncia:</label>
                    <div class="value">${invoice.referencia}</div>
                </div>
                <div class="client-field">
                    <label>Data de Emiss√£o:</label>
                    <div class="value">${invoice.dataEmissao}</div>
                </div>
                <div class="client-field">
                    <label>Data de Vencimento:</label>
                    <div class="value">${invoice.dataVencimento}</div>
                </div>
                <div class="client-field">
                    <label>Roteiriza√ß√£o:</label>
                    <div class="value">${invoice.roteirizacao}</div>
                </div>
            `;
        }

        function displayReadings() {
            const container = document.getElementById('readings-section');
            const hydro = currentInvoiceData.hidrometro;
            
            container.innerHTML = `
                <div class="reading-item">
                    <span class="reading-value">${hydro.leituraAnterior}</span>
                    <div class="reading-label">Leitura Anterior</div>
                </div>
                <div class="reading-item">
                    <span class="reading-value">${hydro.leituraAtual}</span>
                    <div class="reading-label">Leitura Atual</div>
                </div>
                <div class="reading-item">
                    <span class="reading-value">${hydro.consumo}</span>
                    <div class="reading-label">Consumo (m¬≥)</div>
                </div>
                <div class="reading-item">
                    <span class="reading-value">${hydro.diasConsumo}</span>
                    <div class="reading-label">Dias de Consumo</div>
                </div>
            `;
        }

        function displayConsumptionDetails() {
            const container = document.getElementById('consumption-details');
            const hydro = currentInvoiceData.hidrometro;
            const consumoDiario = (hydro.consumo / hydro.diasConsumo).toFixed(1);
            const consumoMensal = hydro.consumo;
            
            container.innerHTML = `
                <div class="detail-item">
                    <div class="detail-value">${consumoDiario}</div>
                    <div class="detail-label">m¬≥/dia</div>
                </div>
                <div class="detail-item">
                    <div class="detail-value">${consumoMensal}</div>
                    <div class="detail-label">m¬≥/m√™s</div>
                </div>
                <div class="detail-item">
                    <div class="detail-value">${hydro.diasConsumo}</div>
                    <div class="detail-label">dias</div>
                </div>
                <div class="detail-item">
                    <div class="detail-value">${hydro.numero.slice(-4)}</div>
                    <div class="detail-label">Hidr√¥metro</div>
                </div>
            `;
            
            document.getElementById('monthlyConsumption').textContent = consumoMensal;
        }

        function displayBilling() {
            const container = document.getElementById('billing-section');
            const valores = currentInvoiceData.valores;
            
            container.innerHTML = `
                <div class="billing-item">
                    <span class="billing-label">üíß Valor da √Ågua</span>
                    <span class="billing-value">R$ ${valores.valorAgua.toFixed(2)}</span>
                </div>
                <div class="billing-item">
                    <span class="billing-label">üìä Juros</span>
                    <span class="billing-value">R$ ${valores.jrs.toFixed(2)}</span>
                </div>
                <div class="billing-item">
                    <span class="billing-label">üìã Parcelamento</span>
                    <span class="billing-value">R$ ${valores.parc.toFixed(2)}</span>
                </div>
                <div class="billing-item">
                    <span class="billing-label">‚ö†Ô∏è Parcela Irregular</span>
                    <span class="billing-value">R$ ${valores.parcIrreg.toFixed(2)}</span>
                </div>
                <div class="billing-item">
                    <span class="billing-label">üí≥ Parcela D√©bito</span>
                    <span class="billing-value">R$ ${valores.parcDeb.toFixed(2)}</span>
                </div>
                <div class="billing-item total">
                    <span class="billing-label">üí∞ TOTAL A PAGAR</span>
                    <span class="billing-value">R$ ${valores.totalPagar.toFixed(2)}</span>
                </div>
            `;
        }

        function displayWaterQuality() {
            const container = document.getElementById('water-quality');
            const quality = currentInvoiceData.qualidade;
            
            container.innerHTML = '';
            Object.keys(quality).forEach(param => {
                const item = quality[param];
                const statusClass = `status-${item.status}`;
                const statusIcon = item.status === 'good' ? '‚úì' : item.status === 'warning' ? '‚ö†' : '‚úó';
                
                container.innerHTML += `
                    <div class="quality-item">
                        <div class="quality-status ${statusClass}">${statusIcon}</div>
                        <div><strong>${item.label}</strong></div>
                        <div>${item.valor}</div>
                    </div>
                `;
            });
        }

        function displayConsumptionChart() {
            const container = document.getElementById('consumption-chart');
            const historico = currentInvoiceData.historico.filter(h => h.consumo > 0 && h.consumo < 1000);
            
            if (historico.length === 0) {
                container.innerHTML = '<p>Dados de hist√≥rico n√£o dispon√≠veis</p>';
                return;
            }
            
            const maxConsumo = Math.max(...historico.map(h => h.consumo));
            
            container.innerHTML = '';
            historico.slice(-8).forEach(item => {
                const height = Math.max((item.consumo / maxConsumo) * 180, 20);
                const bar = document.createElement('div');
                bar.className = 'bar';
                bar.style.height = height + 'px';
                bar.innerHTML = `
                    <div class="bar-value">${item.consumo}</div>
                    <div class="bar-label">${item.mes}</div>
                `;
                container.appendChild(bar);
            });
        }

        function displayHistoryTable() {
            const container = document.getElementById('history-table');
            const historico = currentInvoiceData.historico;
            
            let tableHTML = `
                <thead>
                    <tr>
                        <th>M√™s/Ano</th>
                        <th>Consumo (m¬≥)</th>
                        <th>Valor (R$)</th>
                        <th>M√©dia Di√°ria</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            historico.forEach(item => {
                const mediaDiaria = (item.consumo / 30).toFixed(1);
                const status = item.consumo > 50 ? 'Alto' : item.consumo > 25 ? 'Normal' : 'Baixo';
                const statusColor = item.consumo > 50 ? '#f44336' : item.consumo > 25 ? '#4caf50' : '#ff9800';
                
                tableHTML += `
                    <tr>
                        <td>${item.mes}</td>
                        <td>${item.consumo}</td>
                        <td>R$ ${item.valor.toFixed(2)}</td>
                        <td>${mediaDiaria} m¬≥/dia</td>
                        <td style="color: ${statusColor}; font-weight: bold;">${status}</td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody>';
            container.innerHTML = tableHTML;
        }

        function displayTariffTable() {
            const container = document.getElementById('tariff-table');
            const faixas = currentInvoiceData.faixasConsumo;
            
            let tableHTML = `
                <thead>
                    <tr>
                        <th>Faixa de Consumo</th>
                        <th>Consumo (m¬≥)</th>
                        <th>Tarifa (R$/m¬≥)</th>
                        <th>Valor Parcial (R$)</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            faixas.forEach(faixa => {
                const valorParcial = (faixa.consumo * parseFloat(faixa.tarifa.replace(',', '.'))).toFixed(2);
                tableHTML += `
                    <tr>
                        <td>${faixa.faixa} m¬≥</td>
                        <td>${faixa.consumo}</td>
                        <td>R$ ${parseFloat(faixa.tarifa.replace(',', '.')).toFixed(2)}</td>
                        <td>R$ ${valorParcial}</td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody>';
            container.innerHTML = tableHTML;
            
            document.getElementById('tariff-category').textContent = currentInvoiceData.cliente.categoria;
        }

        function updateAnalysis() {
            const analysis = waterAI.analyzeCompleteData(currentInvoiceData);
            
            // Atualizar recomenda√ß√µes
            const recContainer = document.getElementById('ai-recommendations');
            recContainer.innerHTML = '';
            
            if (analysis.recommendations.length === 0) {
                recContainer.innerHTML = '<p>‚úÖ Parab√©ns! Seu consumo est√° dentro dos padr√µes ideais.</p>';
            } else {
                analysis.recommendations.forEach(rec => {
                    const priorityColor = rec.priority === 'Urgente' ? '#f44336' : 
                                        rec.priority === 'Alta' ? '#ff9800' : '#4caf50';
                    
                    const item = document.createElement('div');
                    item.className = 'recommendation-item';
                    item.innerHTML = `
                        <h4>${rec.category}: ${rec.title}</h4>
                        <p>${rec.description}</p>
                        <div class="recommendation-meta">
                            <span class="meta-item" style="background-color: ${priorityColor}20; color: ${priorityColor};">
                                Prioridade: ${rec.priority}
                            </span>
                            <span class="meta-item">Impacto: ${rec.impact}</span>
                            <span class="meta-item">Economia: ${rec.savings}</span>
                        </div>
                    `;
                    recContainer.appendChild(item);
                });
            }
            
            // Adicionar dicas gerais
            const tips = waterAI.generateWaterTips(currentInvoiceData.hidrometro.consumo);
            if (tips.length > 0) {
                const tipsSection = document.createElement('div');
                tipsSection.innerHTML = '<h4 style="color: #667eea; margin: 20px 0 10px 0;">üí° Dicas de Economia:</h4>';
                tips.forEach(tip => {
                    const tipItem = document.createElement('div');
                    tipItem.className = 'recommendation-item';
                    tipItem.innerHTML = `<p>${tip}</p>`;
                    tipsSection.appendChild(tipItem);
                });
                recContainer.appendChild(tipsSection);
            }
            
            // Atualizar alertas
            const alertsContainer = document.getElementById('alerts-container');
            alertsContainer.innerHTML = '';
            
            analysis.alerts.forEach(alert => {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${alert.type}`;
                alertDiv.innerHTML = alert.message;
                alertsContainer.appendChild(alertDiv);
            });
        }

        // Fun√ß√µes de controle
        function saveAction(action, data) {
            actionHistory.push({ 
                action, 
                data: JSON.parse(JSON.stringify(data)), 
                timestamp: Date.now() 
            });
            if (actionHistory.length > 10) {
                actionHistory.shift();
            }
        }

        function editCompanyInfo() {
            const modal = document.getElementById('editModal');
            const form = document.getElementById('edit-form');
            const info = currentInvoiceData.companyInfo;

            document.getElementById('modal-title').textContent = 'Editar Dados da Concession√°ria';
            
            form.innerHTML = `
                <div class="input-group">
                    <label>Concession√°ria:</label>
                    <input type="text" id="edit-comp-nome" value="${info.nome}">
                </div>
                <div class="input-group">
                    <label>Endere√ßo:</label>
                    <input type="text" id="edit-comp-endereco" value="${info.endereco}">
                </div>
                <div class="input-group">
                    <label>Cidade:</label>
                    <input type="text" id="edit-comp-cidade" value="${info.cidade}">
                </div>
                <div class="input-group">
                    <label>CEP:</label>
                    <input type="text" id="edit-comp-cep" value="${info.cep}">
                </div>
                <div class="input-group">
                    <label>CNPJ:</label>
                    <input type="text" id="edit-comp-cnpj" value="${info.cnpj}">
                </div>
            `;
            
            modal.style.display = 'block';
        }

        function editClient() {
            const modal = document.getElementById('editModal');
            const form = document.getElementById('edit-form');
            const client = currentInvoiceData.cliente;
            
            document.getElementById('modal-title').textContent = 'Editar Dados do Cliente';
            
            form.innerHTML = `
                <div class="input-group">
                    <label>Nome do Cliente:</label>
                    <input type="text" id="edit-nome" value="${client.nome}">
                </div>
                <div class="input-group">
                    <label>Endere√ßo:</label>
                    <textarea id="edit-endereco" rows="3">${client.endereco}</textarea>
                </div>
                <div class="input-group">
                    <label>CEP:</label>
                    <input type="text" id="edit-cep" value="${client.cep}">
                </div>
                <div class="input-group">
                    <label>Categoria:</label>
                    <select id="edit-categoria">
                        <option value="RESIDENCIAL" ${client.categoria === 'RESIDENCIAL' ? 'selected' : ''}>Residencial</option>
                        <option value="COMERCIAL" ${client.categoria === 'COMERCIAL' ? 'selected' : ''}>Comercial</option>
                        <option value="INDUSTRIAL" ${client.categoria === 'INDUSTRIAL' ? 'selected' : ''}>Industrial</option>
                    </select>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        function editInvoice() {
            const modal = document.getElementById('editModal');
            const form = document.getElementById('edit-form');
            const invoice = currentInvoiceData.fatura;
            
            document.getElementById('modal-title').textContent = 'Editar Informa√ß√µes da Fatura';
            
            form.innerHTML = `
                <div class="input-group">
                    <label>N√∫mero da Fatura:</label>
                    <input type="text" id="edit-fat-numero" value="${invoice.numero}">
                </div>
                <div class="input-group">
                    <label>M√™s de Refer√™ncia:</label>
                    <input type="text" id="edit-fat-ref" value="${invoice.referencia}">
                </div>
                <div class="input-group">
                    <label>Data de Emiss√£o:</label>
                    <input type="date" id="edit-fat-emissao" value="${formatDateForInput(invoice.dataEmissao)}">
                </div>
                <div class="input-group">
                    <label>Data de Vencimento:</label>
                    <input type="date" id="edit-fat-vencimento" value="${formatDateForInput(invoice.dataVencimento)}">
                </div>
            `;
            
            modal.style.display = 'block';
        }

        function editReadings() {
            const modal = document.getElementById('editModal');
            const form = document.getElementById('edit-form');
            const hydro = currentInvoiceData.hidrometro;
            
            document.getElementById('modal-title').textContent = 'Editar Leituras do Hidr√¥metro';
            
            form.innerHTML = `
                <div class="input-group">
                    <label>N√∫mero do Hidr√¥metro:</label>
                    <input type="text" id="edit-hydro-numero" value="${hydro.numero}">
                </div>
                <div class="input-group">
                    <label>Leitura Anterior:</label>
                    <input type="number" id="edit-leituraAnterior" value="${hydro.leituraAnterior}">
                </div>
                <div class="input-group">
                    <label>Leitura Atual:</label>
                    <input type="number" id="edit-leituraAtual" value="${hydro.leituraAtual}">
                </div>
                <div class="input-group">
                    <label>Dias de Consumo:</label>
                    <input type="number" id="edit-diasConsumo" value="${hydro.diasConsumo}">
                </div>
            `;
            
            modal.style.display = 'block';
        }
        
        function editConsumption() {
             const modal = document.getElementById('editModal');
            const form = document.getElementById('edit-form');
            const hydro = currentInvoiceData.hidrometro;
            
            document.getElementById('modal-title').textContent = 'Editar An√°lise de Consumo';

            form.innerHTML = `
                <p><strong>Leitura Atual:</strong> ${hydro.leituraAtual} m¬≥</p>
                <p><strong>Consumo (m¬≥):</strong> ${hydro.consumo}</p>
                <p><strong>Dias de Consumo:</strong> ${hydro.diasConsumo}</p>
                <div class="input-group">
                    <label>Consumo M√™s Atual (m¬≥):</label>
                    <input type="number" id="edit-consumo-manual" value="${hydro.consumo}">
                </div>
                <div class="input-group">
                    <label>M√©dia Di√°ria (m¬≥/dia):</label>
                    <input type="number" step="0.1" id="edit-consumo-diario" value="${(hydro.consumo / hydro.diasConsumo).toFixed(1)}">
                </div>
                <p class="alert alert-info" style="margin-top: 20px;">
                    Aten√ß√£o: A edi√ß√£o de consumo manual ir√° sobrescrever o c√°lculo autom√°tico da diferen√ßa entre as leituras.
                </p>
            `;
            
            modal.style.display = 'block';
        }

        function editBilling() {
            const modal = document.getElementById('editModal');
            const form = document.getElementById('edit-form');
            const valores = currentInvoiceData.valores;
            
            document.getElementById('modal-title').textContent = 'Editar Discrimina√ß√£o de Valores';
            
            form.innerHTML = `
                <div class="input-group">
                    <label>Valor da √Ågua (R$):</label>
                    <input type="number" step="0.01" id="edit-valorAgua" value="${valores.valorAgua}">
                </div>
                <div class="input-group">
                    <label>Juros (R$):</label>
                    <input type="number" step="0.01" id="edit-juros" value="${valores.jrs}">
                </div>
                <div class="input-group">
                    <label>Parcelamento (R$):</label>
                    <input type="number" step="0.01" id="edit-parc" value="${valores.parc}">
                </div>
                <div class="input-group">
                    <label>Parcela Irregular (R$):</label>
                    <input type="number" step="0.01" id="edit-parcIrreg" value="${valores.parcIrreg}">
                </div>
                <div class="input-group">
                    <label>Parcela D√©bito (R$):</label>
                    <input type="number" step="0.01" id="edit-parcDeb" value="${valores.parcDeb}">
                </div>
                <div class="input-group">
                    <label>Total a Pagar (R$):</label>
                    <input type="number" step="0.01" id="edit-totalPagar" value="${valores.totalPagar}">
                </div>
            `;
            
            modal.style.display = 'block';
        }

        function editWaterQuality() {
            const modal = document.getElementById('editModal');
            const form = document.getElementById('edit-form');
            const qualidade = currentInvoiceData.qualidade;

            document.getElementById('modal-title').textContent = 'Editar Qualidade da √Ågua';
            
            form.innerHTML = `
                <div class="input-group">
                    <label>pH:</label>
                    <input type="number" step="0.1" id="edit-ph" value="${qualidade.ph.valor}">
                </div>
                <div class="input-group">
                    <label>Cloro (mg/L):</label>
                    <input type="number" step="0.1" id="edit-cloro" value="${qualidade.cloro.valor}">
                </div>
                <div class="input-group">
                    <label>Turbidez (NTU):</label>
                    <input type="number" step="0.1" id="edit-turbidez" value="${qualidade.turbidez.valor}">
                </div>
                <div class="input-group">
                    <label>Coliformes:</label>
                    <input type="number" id="edit-coliformes" value="${qualidade.coliformes.valor}">
                </div>
            `;
            
            modal.style.display = 'block';
        }

        function saveChanges() {
            const modalTitle = document.getElementById('modal-title').textContent;
            
            if (modalTitle.includes('Concession√°ria')) {
                saveAction('editCompanyInfo', currentInvoiceData.companyInfo);
                currentInvoiceData.companyInfo.nome = document.getElementById('edit-comp-nome').value;
                currentInvoiceData.companyInfo.endereco = document.getElementById('edit-comp-endereco').value;
                currentInvoiceData.companyInfo.cidade = document.getElementById('edit-comp-cidade').value;
                currentInvoiceData.companyInfo.cep = document.getElementById('edit-comp-cep').value;
                currentInvoiceData.companyInfo.cnpj = document.getElementById('edit-comp-cnpj').value;
            } else if (modalTitle.includes('Cliente')) {
                saveAction('editClient', currentInvoiceData.cliente);
                currentInvoiceData.cliente.nome = document.getElementById('edit-nome').value;
                currentInvoiceData.cliente.endereco = document.getElementById('edit-endereco').value;
                currentInvoiceData.cliente.cep = document.getElementById('edit-cep').value;
                currentInvoiceData.cliente.categoria = document.getElementById('edit-categoria').value;
            } else if (modalTitle.includes('Fatura')) {
                saveAction('editInvoice', currentInvoiceData.fatura);
                currentInvoiceData.fatura.numero = document.getElementById('edit-fat-numero').value;
                currentInvoiceData.fatura.referencia = document.getElementById('edit-fat-ref').value;
                currentInvoiceData.fatura.dataEmissao = document.getElementById('edit-fat-emissao').value.split('-').reverse().join('/');
                currentInvoiceData.fatura.dataVencimento = document.getElementById('edit-fat-vencimento').value.split('-').reverse().join('/');
            } else if (modalTitle.includes('Leituras')) {
                saveAction('editReadings', currentInvoiceData.hidrometro);
                const leituraAnterior = parseInt(document.getElementById('edit-leituraAnterior').value);
                const leituraAtual = parseInt(document.getElementById('edit-leituraAtual').value);
                currentInvoiceData.hidrometro.numero = document.getElementById('edit-hydro-numero').value;
                currentInvoiceData.hidrometro.leituraAnterior = leituraAnterior;
                currentInvoiceData.hidrometro.leituraAtual = leituraAtual;
                currentInvoiceData.hidrometro.consumo = leituraAtual - leituraAnterior;
                currentInvoiceData.hidrometro.diasConsumo = parseInt(document.getElementById('edit-diasConsumo').value);
            } else if (modalTitle.includes('Consumo')) {
                 saveAction('editConsumption', currentInvoiceData.hidrometro);
                 currentInvoiceData.hidrometro.consumo = parseFloat(document.getElementById('edit-consumo-manual').value);
            } else if (modalTitle.includes('Valores')) {
                saveAction('editBilling', currentInvoiceData.valores);
                currentInvoiceData.valores.valorAgua = parseFloat(document.getElementById('edit-valorAgua').value);
                currentInvoiceData.valores.jrs = parseFloat(document.getElementById('edit-juros').value);
                currentInvoiceData.valores.parc = parseFloat(document.getElementById('edit-parc').value);
                currentInvoiceData.valores.parcIrreg = parseFloat(document.getElementById('edit-parcIrreg').value);
                currentInvoiceData.valores.parcDeb = parseFloat(document.getElementById('edit-parcDeb').value);
                currentInvoiceData.valores.totalPagar = parseFloat(document.getElementById('edit-totalPagar').value);
            } else if (modalTitle.includes('Qualidade')) {
                saveAction('editWaterQuality', currentInvoiceData.qualidade);
                currentInvoiceData.qualidade.ph.valor = parseFloat(document.getElementById('edit-ph').value);
                currentInvoiceData.qualidade.cloro.valor = parseFloat(document.getElementById('edit-cloro').value);
                currentInvoiceData.qualidade.turbidez.valor = parseFloat(document.getElementById('edit-turbidez').value);
                currentInvoiceData.qualidade.coliformes.valor = parseInt(document.getElementById('edit-coliformes').value);
            }
            
            closeModal();
            updateDisplay();
            showAlert('success', '‚úÖ Dados atualizados com sucesso!');
        }
        
        function clearFields() {
            const form = document.getElementById('edit-form');
            const inputs = form.querySelectorAll('input, textarea');
            inputs.forEach(input => {
                if (input.type === 'number') {
                    input.value = '0';
                } else if (input.tagName === 'TEXTAREA') {
                    input.value = '';
                } else {
                    input.value = '';
                }
            });
            showAlert('info', '‚úÖ Campos limpos. Pressione "Corrigir" para salvar as altera√ß√µes.');
        }

        // Helper para formatar data de DD/MM/AAAA para AAAA-MM-DD
        function formatDateForInput(dateString) {
            if (!dateString || dateString.length !== 10) return '';
            const [day, month, year] = dateString.split('/');
            return `${year}-${month}-${day}`;
        }
        
        function addNewInvoice() {
            const novaFatura = prompt('Digite: leituraAnterior,leituraAtual,valorTotal (ex: 1025,1056,850.50)');
            if (novaFatura) {
                try {
                    const [anterior, atual, valor] = novaFatura.split(',');
                    const novoMes = new Date().toLocaleDateString('pt-BR', { month: '2-digit', year: 'numeric' });
                    
                    const newInvoice = JSON.parse(JSON.stringify(currentInvoiceData));
                    newInvoice.hidrometro.leituraAnterior = parseInt(anterior);
                    newInvoice.hidrometro.leituraAtual = parseInt(atual);
                    newInvoice.hidrometro.consumo = parseInt(atual) - parseInt(anterior);
                    newInvoice.valores.totalPagar = parseFloat(valor);
                    newInvoice.fatura.referencia = novoMes;
                    
                    invoiceHistory.push(newInvoice);
                    showAlert('success', '‚úÖ Nova fatura adicionada ao hist√≥rico!');
                } catch (error) {
                    showAlert('danger', '‚ùå Erro no formato dos dados. Use: anterior,atual,valor');
                }
            }
        }

        function compareConsumption() {
            if (invoiceHistory.length < 2) {
                showAlert('warning', '‚ö†Ô∏è √â necess√°rio pelo menos 2 faturas para compara√ß√£o.');
                return;
            }
            
            const current = currentInvoiceData.hidrometro.consumo;
            const previous = invoiceHistory[invoiceHistory.length - 2].hidrometro.consumo;
            const diff = current - previous;
            const percentChange = ((diff / previous) * 100).toFixed(1);
            
            const message = diff > 0 ? 
                `üìà Aumento de ${diff}m¬≥ (${percentChange}%) em rela√ß√£o ao m√™s anterior` :
                `üìâ Redu√ß√£o de ${Math.abs(diff)}m¬≥ (${Math.abs(percentChange)}%) em rela√ß√£o ao m√™s anterior`;
            
            showAlert(diff > 0 ? 'warning' : 'success', message);
        }

        function generateReport() {
            const report = `
                RELAT√ìRIO DE CONSUMO - ${currentInvoiceData.cliente.nome}
                ================================================
                
                Per√≠odo: ${currentInvoiceData.fatura.referencia}
                Consumo: ${currentInvoiceData.hidrometro.consumo} m¬≥
                Valor Total: R$ ${currentInvoiceData.valores.totalPagar.toFixed(2)}
                
                M√©dia dos √∫ltimos meses: ${waterAI.calculateHistoricalAverage(currentInvoiceData.historico).toFixed(1)} m¬≥
                Tend√™ncia: ${waterAI.analyzeTrend(currentInvoiceData.historico)}
                
                Gerado em: ${new Date().toLocaleString('pt-BR')}
            `;
            
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `relatorio_agua_${currentInvoiceData.fatura.referencia.replace('/', '_')}.txt`;
            link.click();
            
            showAlert('success', 'üìã Relat√≥rio gerado e baixado!');
        }

        function exportData() {
            const dataStr = JSON.stringify({ 
                currentInvoiceData, 
                invoiceHistory, 
                exportDate: new Date().toISOString() 
            }, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `backup_aquaia_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showAlert('success', 'üì§ Dados exportados com sucesso!');
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.currentInvoiceData && data.invoiceHistory) {
                            currentInvoiceData = data.currentInvoiceData;
                            invoiceHistory = data.invoiceHistory;
                            updateDisplay();
                            showAlert('success', 'üì• Dados importados com sucesso!');
                        } else {
                            showAlert('danger', '‚ùå Formato de arquivo inv√°lido!');
                        }
                    } catch (error) {
                        showAlert('danger', '‚ùå Erro ao importar dados!');
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }

        function downloadPDF() {
            showAlert('info', 'Gerando PDF... Esta fun√ß√£o √© uma simula√ß√£o.');
            
            const pdfContent = `
                Fatura √Åguas de Manaus
                ----------------------------------
                
                Nome do Cliente: ${currentInvoiceData.cliente.nome}
                Matr√≠cula: ${currentInvoiceData.cliente.matricula}
                Endere√ßo: ${currentInvoiceData.cliente.endereco}
                
                Refer√™ncia: ${currentInvoiceData.fatura.referencia}
                Consumo: ${currentInvoiceData.hidrometro.consumo} m¬≥
                Total a Pagar: R$ ${currentInvoiceData.valores.totalPagar.toFixed(2)}
                
                Detalhes do Consumo:
                Leitura Anterior: ${currentInvoiceData.hidrometro.leituraAnterior}
                Leitura Atual: ${currentInvoiceData.hidrometro.leituraAtual}
                Dias de Consumo: ${currentInvoiceData.hidrometro.diasConsumo}
                
                Discrimina√ß√£o de Valores:
                √Ågua: R$ ${currentInvoiceData.valores.valorAgua.toFixed(2)}
                Juros: R$ ${currentInvoiceData.valores.jrs.toFixed(2)}
                Parcelamento: R$ ${currentInvoiceData.valores.parc.toFixed(2)}
                Parcela Irregular: R$ ${currentInvoiceData.valores.parcIrreg.toFixed(2)}
                Parcela D√©bito: R$ ${currentInvoiceData.valores.parcDeb.toFixed(2)}
                
                An√°lise da Qualidade da √Ågua:
                pH: ${currentInvoiceData.qualidade.ph.valor}
                Cloro: ${currentInvoiceData.qualidade.cloro.valor} mg/L
                Turbidez: ${currentInvoiceData.qualidade.turbidez.valor} NTU
                Coliformes: ${currentInvoiceData.qualidade.coliformes.valor}
                
                Relat√≥rio gerado por AquaIA em ${new Date().toLocaleDateString('pt-BR')}.
            `;

            const blob = new Blob([pdfContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `fatura-agua-${currentInvoiceData.fatura.referencia.replace('/', '-')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function viewFullAddress() {
            const fullAddress = currentInvoiceData.cliente.endereco;
            alert(`Endere√ßo completo:\n${fullAddress}`);
        }

        function undoLastAction() {
            if (actionHistory.length === 0) {
                showAlert('info', 'N√£o h√° a√ß√µes para desfazer.');
                return;
            }
            
            const lastAction = actionHistory.pop();
            
            if (lastAction.action === 'editClient') {
                currentInvoiceData.cliente = lastAction.data;
                showAlert('success', 'A√ß√£o de edi√ß√£o do cliente desfeita.');
            } else if (lastAction.action === 'editInvoice') {
                currentInvoiceData.fatura = lastAction.data;
                showAlert('success', 'A√ß√£o de edi√ß√£o da fatura desfeita.');
            } else if (lastAction.action === 'editReadings') {
                currentInvoiceData.hidrometro = lastAction.data;
                showAlert('success', 'A√ß√£o de edi√ß√£o de leituras desfeita.');
            } else if (lastAction.action === 'editConsumption') {
                currentInvoiceData.hidrometro.consumo = lastAction.data.consumo;
                showAlert('success', 'A√ß√£o de edi√ß√£o de consumo desfeita.');
            } else if (lastAction.action === 'editBilling') {
                currentInvoiceData.valores = lastAction.data;
                showAlert('success', 'A√ß√£o de edi√ß√£o de valores desfeita.');
            } else if (lastAction.action === 'editWaterQuality') {
                currentInvoiceData.qualidade = lastAction.data;
                showAlert('success', 'A√ß√£o de edi√ß√£o da qualidade da √°gua desfeita.');
            } else if (lastAction.action === 'editCompanyInfo') {
                currentInvoiceData.companyInfo = lastAction.data;
                showAlert('success', 'A√ß√£o de edi√ß√£o da concession√°ria desfeita.');
            } else {
                showAlert('warning', `N√£o foi poss√≠vel desfazer a √∫ltima a√ß√£o (${lastAction.action}).`);
            }
            
            updateDisplay();
        }

        function resetSystem() {
            const confirmReset = confirm('Tem certeza que deseja resetar o sistema? Todos os dados n√£o salvos ser√£o perdidos.');
            
            if (confirmReset) {
                currentInvoiceData = {
                    companyInfo: {
                        nome: "√ÅGUAS DE MANAUS S/A",
                        endereco: "RUA DO BOMBEAMENTO, 01, COMPENSA",
                        cidade: "MANAUS/AM",
                        cep: "69029-160",
                        cnpj: "03.764.977/0001-27",
                        inscricaoEstadual: "04.141.933-5"
                    },
                    cliente: {
                        nome: "N/A",
                        matricula: "N/A",
                        endereco: "N/A",
                        cep: "N/A",
                        categoria: "RESIDENCIAL",
                        tarifa: "RESIDENCIAL",
                        situacao: "INATIVA"
                    },
                    fatura: {
                        numero: "N/A",
                        referencia: "00/0000",
                        dataEmissao: "00/00/0000",
                        dataVencimento: "00/00/0000",
                        roteirizacao: "N/A"
                    },
                    hidrometro: {
                        numero: "N/A",
                        leituraAnterior: 0,
                        leituraAtual: 0,
                        consumo: 0,
                        diasConsumo: 0,
                        multiplicador: 1
                    },
                    historico: [],
                    valores: {
                        valorAgua: 0,
                        jrs: 0,
                        parc: 0,
                        parcIrreg: 0,
                        parcDeb: 0,
                        totalPagar: 0
                    },
                    faixasConsumo: [],
                    qualidade: {
                        ph: { valor: "N/A", status: "warning", label: "pH" },
                        cloro: { valor: "N/A", status: "warning", label: "Cloro (mg/L)" },
                        turbidez: { valor: "N/A", status: "warning", label: "Turbidez (NTU)" },
                        coliformes: { valor: "N/A", status: "warning", label: "Coliformes" }
                    }
                };
                invoiceHistory = [currentInvoiceData];
                actionHistory = [];
                
                updateDisplay();
                showAlert('danger', 'üóëÔ∏è Sistema resetado para o estado inicial!');
            }
        }

        function showHelp() {
            alert(`
                Manual de Ajuda AquaIA

                - Editar Dados do Cliente: Clique em "Editar" para alterar nome, endere√ßo e categoria do cliente.
                - Editar Dados da Fatura: Clique em "Editar" para atualizar as leituras e valores da fatura.
                - PDF: Simula a gera√ß√£o de um arquivo de texto com as informa√ß√µes da fatura.
                - Nova Fatura: Adiciona uma nova fatura ao hist√≥rico (requer entrada manual).
                - Comparar: Compara o consumo do m√™s atual com o m√™s anterior no hist√≥rico.
                - Relat√≥rio: Gera um relat√≥rio simples em formato de texto.
                - Exportar/Importar: Salva ou carrega os dados do sistema em um arquivo JSON.
                - Desfazer: Desfaz a √∫ltima altera√ß√£o feita nos dados do cliente ou fatura.
                - Reset: Apaga todos os dados e retorna o sistema ao estado inicial.
            `);
        }

        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        function showAlert(type, message) {
            const alertsContainer = document.getElementById('alerts-container');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = message;
            alertsContainer.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Fun√ß√£o de inicializa√ß√£o
        function updateDisplay() {
            displayCompanyInfo();
            displayClientData();
            displayInvoiceData();
            displayReadings();
            displayConsumptionDetails();
            displayBilling();
            displayWaterQuality();
            displayConsumptionChart();
            displayHistoryTable();
            displayTariffTable();
            updateAnalysis();
        }

        document.addEventListener('DOMContentLoaded', updateDisplay);

    </script>
</body>
</html>
