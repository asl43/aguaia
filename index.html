<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AquaIA - Sistema Inteligente de An√°lise de Conta de √Ågua</title>
    <style>
        /* Estilos Globais */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            padding: 30px;
        }

        .header {
            text-align: center;
            color: #333;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3.5rem;
            margin-bottom: 10px;
            color: #667eea;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        .header p {
            font-size: 1.1rem;
            color: #555;
        }

        /* Menu Acorde√£o */
        .accordion-item {
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
            background: #f9f9f9;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .accordion-header {
            background: #e8e8f8;
            padding: 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.4rem;
            font-weight: bold;
            color: #4a5e9a;
            border-bottom: 2px solid #ddd;
            transition: background 0.3s ease;
        }

        .accordion-header:hover {
            background: #dcdcf0;
        }

        .accordion-header .icon {
            margin-right: 15px;
            font-size: 1.8rem;
            color: #667eea;
        }

        .accordion-content {
            padding: 20px;
            display: none;
            flex-direction: column;
            gap: 20px;
            border-top: 1px solid #e0e0e0;
        }
        
        .accordion-header:not(.active) .arrow {
            transform: rotate(0deg);
        }
        
        .accordion-header.active .arrow {
            transform: rotate(180deg);
        }

        .arrow {
            transition: transform 0.3s ease;
        }

        /* Se√ß√µes do Formul√°rio */
        .form-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-weight: 600;
            color: #555;
            margin-bottom: 5px;
            font-size: 0.95rem;
        }

        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        /* Bot√µes */
        .btn-group {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn-group.center {
            justify-content: center;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .btn.primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }
        
        .btn.secondary {
            background: #e0e0e0;
            color: #555;
        }

        .btn.secondary:hover {
            background: #d0d0d0;
        }

        .btn.danger {
            background: #e74c3c;
            color: white;
        }

        .btn.danger:hover {
            background: #c0392b;
        }
        
        .btn.info {
            background: #3498db;
            color: white;
        }

        .btn.info:hover {
            background: #2980b9;
        }

        /* Exibi√ß√£o de Dados (sem o formul√°rio) */
        .data-display {
            padding: 15px;
            background: #fff;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
            line-height: 1.6;
        }

        .data-item {
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .data-label {
            font-weight: 600;
            color: #4a5e9a;
        }

        .data-value {
            font-weight: 400;
        }
        
        /* Se√ß√£o do Hidr√¥metro */
        .daily-reading-container {
            display: flex;
            align-items: center;
            gap: 15px;
            background: #f0f0f8;
            padding: 15px;
            border-radius: 10px;
        }

        .daily-reading-container input {
            flex-grow: 1;
        }

        .reading-table-container {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        .reading-table {
            width: 100%;
            border-collapse: collapse;
        }

        .reading-table th, .reading-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .reading-table th {
            background: #e8e8f8;
            color: #4a5e9a;
            font-weight: bold;
            position: sticky;
            top: 0;
        }

        .reading-table td {
            background: #fff;
        }

        .reading-table tr:hover td {
            background: #f6f6ff;
        }
        
        .reading-table .btn {
            padding: 5px 10px;
            font-size: 0.85rem;
        }
        
        /* An√°lise do Consumo */
        .analysis-card {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .analysis-card h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        /* Alertas e mensagens */
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid transparent;
            font-weight: bold;
        }
        .alert-success { background: #d4edda; color: #155724; border-color: #c3e6cb; }
        .alert-info { background: #d1ecf1; color: #0c5460; border-color: #bee5eb; }
        .alert-warning { background: #fff3cd; color: #856404; border-color: #ffeeba; }
        .alert-danger { background: #f8d7da; color: #721c24; border-color: #f5c6cb; }

        /* Recomenda√ß√µes */
        .recommendation-card {
            background: #f0f0f8;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            display: none; /* Inicia oculto */
        }

        .recommendation-item {
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            padding-left: 15px;
        }
        
        /* OCR */
        #ocr-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
        }
        #ocr-preview {
            max-width: 100%;
            height: auto;
            max-height: 400px;
            border-radius: 10px;
            border: 1px solid #ddd;
            display: none;
        }
        
        /* Gr√°fico */
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
            margin-top: 20px;
        }

        .empty-state {
            text-align: center;
            color: #777;
            padding: 20px;
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>AquaIA üíßü§ñ</h1>
            <p>Sistema Inteligente de An√°lise de Conta de √Ågua</p>
        </div>
        
        <div id="alerts-container"></div>

        <div class="accordion-item">
            <div class="accordion-header" onclick="toggleAccordion('ocr')">
                <div class="icon">üìÑ</div>
                <span>Carregar Fatura (OCR)</span>
                <span class="arrow">‚ñº</span>
            </div>
            <div class="accordion-content" id="ocrContent">
                <div id="ocr-section">
                    <h4>Analisar Fatura por Imagem</h4>
                    <p>Fa√ßa o upload de uma imagem da sua conta de √°gua ou tire uma foto.</p>
                    <input type="file" id="ocr-upload" accept="image/*" capture="camera" style="display: none;">
                    <button class="btn info" onclick="document.getElementById('ocr-upload').click()">Tirar Foto ou Escolher Arquivo</button>
                    <img id="ocr-preview" src="#" alt="Pr√©-visualiza√ß√£o da fatura">
                </div>
            </div>
        </div>

        <div class="accordion-item">
            <div class="accordion-header" onclick="toggleAccordion('companyInfo')">
                <div class="icon">üè¢</div>
                <span>Informa√ß√µes da Concession√°ria</span>
                <span class="arrow">‚ñº</span>
            </div>
            <div class="accordion-content" id="companyInfoContent">
                <div class="data-display" id="company-info-display"></div>
                <div class="form-section">
                    <div class="input-group">
                        <label for="company-nome">Nome da Concession√°ria</label>
                        <input type="text" id="company-nome">
                    </div>
                    <div class="input-group">
                        <label for="company-endereco">Endere√ßo</label>
                        <input type="text" id="company-endereco">
                    </div>
                    <div class="input-group">
                        <label for="company-cnpj">CNPJ</label>
                        <input type="text" id="company-cnpj">
                    </div>
                    <div class="btn-group">
                        <button class="btn secondary" onclick="clearFields('company')">Limpar</button>
                        <button class="btn primary" onclick="saveCompanyInfo()">Salvar</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="accordion-item">
            <div class="accordion-header" onclick="toggleAccordion('clientInfo')">
                <div class="icon">üë§</div>
                <span>Dados do Cliente</span>
                <span class="arrow">‚ñº</span>
            </div>
            <div class="accordion-content" id="clientInfoContent">
                <div class="data-display" id="client-info-display"></div>
                <div class="form-section">
                    <div class="input-group">
                        <label for="client-nome">Nome Completo</label>
                        <input type="text" id="client-nome">
                    </div>
                    <div class="input-group">
                        <label for="client-matricula">Matr√≠cula</label>
                        <input type="text" id="client-matricula">
                    </div>
                    <div class="input-group">
                        <label for="client-endereco">Endere√ßo Completo</label>
                        <textarea id="client-endereco" rows="3"></textarea>
                    </div>
                    <div class="btn-group">
                        <button class="btn secondary" onclick="clearFields('client')">Limpar</button>
                        <button class="btn primary" onclick="saveClientInfo()">Salvar</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="accordion-item">
            <div class="accordion-header" onclick="toggleAccordion('readings')">
                <div class="icon">üìä</div>
                <span>Leituras do Hidr√¥metro e Consumo</span>
                <span class="arrow">‚ñº</span>
            </div>
            <div class="accordion-content" id="readingsContent">
                <div class="data-display" id="readings-display"></div>
                
                <div class="analysis-card">
                    <h4>Registro de Leituras Di√°rias</h4>
                    <div class="daily-reading-container">
                        <input type="number" id="daily-reading-input" placeholder="Nova leitura (m¬≥)">
                        <button class="btn primary" onclick="addDailyReading()">Salvar</button>
                    </div>
                    <div class="reading-table-container">
                        <table class="reading-table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Leitura (m¬≥)</th>
                                    <th>A√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody id="daily-readings-table"></tbody>
                        </table>
                    </div>
                    <div class="btn-group" style="margin-top: 10px;">
                        <button class="btn secondary" onclick="clearDailyReadings()">Limpar Leituras</button>
                        <button class="btn primary" onclick="saveMonthlyReading()">Salvar como Mensal</button>
                    </div>
                </div>
                
                <div class="analysis-card" style="margin-top: 20px;">
                    <h4>Leituras Mensais</h4>
                    <div class="reading-table-container">
                        <table class="reading-table">
                            <thead>
                                <tr>
                                    <th>Refer√™ncia</th>
                                    <th>Leitura (m¬≥)</th>
                                    <th>Consumo (m¬≥)</th>
                                    <th>A√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody id="monthly-readings-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="accordion-item">
            <div class="accordion-header" onclick="toggleAccordion('billing')">
                <div class="icon">üí∞</div>
                <span>Discrimina√ß√£o de Valores</span>
                <span class="arrow">‚ñº</span>
            </div>
            <div class="accordion-content" id="billingContent">
                <div class="data-display" id="billing-display"></div>
                <div class="form-section">
                    <div class="input-group">
                        <label for="valor-agua">Valor da √Ågua (R$)</label>
                        <input type="number" id="valor-agua" step="0.01">
                    </div>
                    <div class="input-group">
                        <label for="juros">Juros (R$)</label>
                        <input type="number" id="juros" step="0.01">
                    </div>
                    <div class="input-group">
                        <label for="total-pagar">Total a Pagar (R$)</label>
                        <input type="number" id="total-pagar" step="0.01">
                    </div>
                    <div class="btn-group">
                        <button class="btn secondary" onclick="clearFields('billing')">Limpar</button>
                        <button class="btn primary" onclick="saveBillingInfo()">Salvar</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="accordion-item">
            <div class="accordion-header" onclick="toggleAccordion('analysis')">
                <div class="icon">üìä</div>
                <span>An√°lise de Consumo e Hist√≥rico</span>
                <span class="arrow">‚ñº</span>
            </div>
            <div class="accordion-content" id="analysisContent">
                <div class="analysis-card">
                    <h4>Resumo do Consumo</h4>
                    <div class="data-display" id="consumption-analysis"></div>
                </div>

                <div class="recommendation-card" id="recommendation-card">
                    <h4>Recomenda√ß√µes da IA</h4>
                    <div id="recommendations-list"></div>
                </div>

                <div class="analysis-card" style="margin-top: 20px;">
                    <h4>Hist√≥rico Mensal</h4>
                    <div class="reading-table-container">
                        <table class="reading-table">
                            <thead>
                                <tr>
                                    <th>M√™s</th>
                                    <th>Consumo (m¬≥)</th>
                                    <th>Valor (R$)</th>
                                </tr>
                            </thead>
                            <tbody id="history-table"></tbody>
                        </table>
                    </div>
                </div>

                <div class="analysis-card" style="margin-top: 20px;">
                    <h4>Gr√°fico de Consumo</h4>
                    <div class="chart-container">
                        <canvas id="consumptionChart"></canvas>
                    </div>
                </div>
                <div class="btn-group center">
                    <button class="btn primary" onclick="updateDisplay()">Atualizar Gr√°ficos e An√°lise</button>
                </div>
            </div>
        </div>

        <div class="btn-group center" style="margin-top: 30px;">
            <button class="btn info" onclick="generatePDF()">Gerar Relat√≥rio em PDF</button>
            <button class="btn info" onclick="exportData()">Exportar Dados</button>
            <button class="btn danger" onclick="resetSystem()">Limpar Tudo</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script>
        let data = {
            companyInfo: {
                nome: "√ÅGUAS DE MANAUS S/A",
                endereco: "RUA DO BOMBEAMENTO, 01, COMPENSA",
                cnpj: "03.764.977/0001-27"
            },
            clientInfo: {
                nome: "ARNOLD SOUZA DE LIMA",
                matricula: "4239385-0",
                endereco: "RUA DIVINOPOLIS - 50, TERRA NOVA - LOT. RIO PIORINI, MANAUS"
            },
            readings: {
                leituraAnterior: 994,
                leituraAtual: 1025
            },
            billing: {
                valorAgua: 250.59,
                juros: 4.63,
                totalPagar: 770.95
            },
            dailyReadings: [],
            monthlyReadings: [
                { date: "08/2025", reading: 1025 },
                { date: "07/2025", reading: 994 },
                { date: "06/2025", reading: 950 },
                { date: "05/2025", reading: 920 },
                { date: "04/2025", reading: 880 }
            ],
            consumptionHistory: [
                { mes: "08/2025", consumo: 31, valor: 770.95 },
                { mes: "07/2025", consumo: 44, valor: 450.30 },
                { mes: "06/2025", consumo: 30, valor: 310.20 },
                { mes: "05/2025", consumo: 40, valor: 405.50 }
            ]
        };

        let consumptionChart;

        function loadData() {
            const savedData = localStorage.getItem('aquaiaData');
            if (savedData) {
                data = JSON.parse(savedData);
                showAlert('info', 'Dados carregados com sucesso do armazenamento local.');
            }
            updateDisplay();
        }

        function saveData() {
            localStorage.setItem('aquaiaData', JSON.stringify(data));
        }

        function updateDisplay() {
            displayCompanyInfo();
            displayClientInfo();
            displayReadings();
            displayBilling();
            displayAnalysis();
            displayDailyReadingsTable();
            displayMonthlyReadingsTable();
            displayConsumptionHistoryTable();
            checkAndDisplayRecommendations();
            createConsumptionChart();
        }

        function displayCompanyInfo() {
            const display = document.getElementById('company-info-display');
            if (data.companyInfo.nome) {
                display.innerHTML = `
                    <div class="data-item"><span class="data-label">Concession√°ria:</span> <span class="data-value">${data.companyInfo.nome}</span></div>
                    <div class="data-item"><span class="data-label">Endere√ßo:</span> <span class="data-value">${data.companyInfo.endereco}</span></div>
                    <div class="data-item"><span class="data-label">CNPJ:</span> <span class="data-value">${data.companyInfo.cnpj}</span></div>
                `;
            } else {
                display.innerHTML = '<div class="empty-state">Nenhuma informa√ß√£o de concession√°ria salva.</div>';
            }
            document.getElementById('company-nome').value = data.companyInfo.nome;
            document.getElementById('company-endereco').value = data.companyInfo.endereco;
            document.getElementById('company-cnpj').value = data.companyInfo.cnpj;
        }
        
        function saveCompanyInfo() {
            data.companyInfo.nome = document.getElementById('company-nome').value;
            data.companyInfo.endereco = document.getElementById('company-endereco').value;
            data.companyInfo.cnpj = document.getElementById('company-cnpj').value;
            saveData();
            updateDisplay();
            showAlert('success', 'Informa√ß√µes da Concession√°ria salvas com sucesso!');
        }

        function displayClientInfo() {
            const display = document.getElementById('client-info-display');
            if (data.clientInfo.nome) {
                 display.innerHTML = `
                    <div class="data-item"><span class="data-label">Nome:</span> <span class="data-value">${data.clientInfo.nome}</span></div>
                    <div class="data-item"><span class="data-label">Matr√≠cula:</span> <span class="data-value">${data.clientInfo.matricula}</span></div>
                    <div class="data-item"><span class="data-label">Endere√ßo:</span> <span class="data-value">${data.clientInfo.endereco}</span></div>
                `;
            } else {
                display.innerHTML = '<div class="empty-state">Nenhum dado do cliente salvo.</div>';
            }
            document.getElementById('client-nome').value = data.clientInfo.nome;
            document.getElementById('client-matricula').value = data.clientInfo.matricula;
            document.getElementById('client-endereco').value = data.clientInfo.endereco;
        }

        function saveClientInfo() {
            data.clientInfo.nome = document.getElementById('client-nome').value;
            data.clientInfo.matricula = document.getElementById('client-matricula').value;
            data.clientInfo.endereco = document.getElementById('client-endereco').value;
            saveData();
            updateDisplay();
            showAlert('success', 'Dados do Cliente salvos com sucesso!');
        }

        function displayReadings() {
            const display = document.getElementById('readings-display');
            if (data.readings.leituraAtual && data.readings.leituraAnterior) {
                const consumo = data.readings.leituraAtual - data.readings.leituraAnterior;
                display.innerHTML = `
                    <div class="data-item"><span class="data-label">Leitura Anterior:</span> <span class="data-value">${data.readings.leituraAnterior} m¬≥</span></div>
                    <div class="data-item"><span class="data-label">Leitura Atual:</span> <span class="data-value">${data.readings.leituraAtual} m¬≥</span></div>
                    <div class="data-item"><span class="data-label">Consumo do M√™s:</span> <span class="data-value">${consumo} m¬≥</span></div>
                `;
            } else {
                display.innerHTML = '<div class="empty-state">Nenhum dado de leitura mensal salvo.</div>';
            }
        }
        
        function displayBilling() {
            const display = document.getElementById('billing-display');
            if (data.billing.totalPagar) {
                display.innerHTML = `
                    <div class="data-item"><span class="data-label">Valor da √Ågua:</span> <span class="data-value">R$ ${data.billing.valorAgua.toFixed(2)}</span></div>
                    <div class="data-item"><span class="data-label">Juros:</span> <span class="data-value">R$ ${data.billing.juros.toFixed(2)}</span></div>
                    <div class="data-item"><span class="data-label">Total a Pagar:</span> <span class="data-value">R$ ${data.billing.totalPagar.toFixed(2)}</span></div>
                `;
            } else {
                display.innerHTML = '<div class="empty-state">Nenhum dado de valores salvo.</div>';
            }
            document.getElementById('valor-agua').value = data.billing.valorAgua;
            document.getElementById('juros').value = data.billing.juros;
            document.getElementById('total-pagar').value = data.billing.totalPagar;
        }

        function saveBillingInfo() {
            data.billing.valorAgua = parseFloat(document.getElementById('valor-agua').value) || 0;
            data.billing.juros = parseFloat(document.getElementById('juros').value) || 0;
            data.billing.totalPagar = parseFloat(document.getElementById('total-pagar').value) || 0;
            saveData();
            updateDisplay();
            showAlert('success', 'Discrimina√ß√£o de valores salva com sucesso!');
        }

        function displayAnalysis() {
            const display = document.getElementById('consumption-analysis');
            if (data.consumptionHistory.length === 0) {
                display.innerHTML = '<div class="empty-state">Adicione dados de consumo para ver a an√°lise.</div>';
                return;
            }

            const consumo = data.readings.leituraAtual - data.readings.leituraAnterior;
            const avgConsumption = data.consumptionHistory.reduce((sum, item) => sum + item.consumo, 0) / data.consumptionHistory.length;
            const percentageChange = avgConsumption > 0 ? ((consumo - avgConsumption) / avgConsumption) * 100 : 0;
            
            let status, alertType;
            if (consumo > avgConsumption * 1.2) {
                status = 'muito alto';
                alertType = 'danger';
            } else if (consumo > avgConsumption * 1.05) {
                status = 'acima da m√©dia';
                alertType = 'warning';
            } else if (consumo < avgConsumption * 0.95) {
                status = 'abaixo da m√©dia';
                alertType = 'success';
            } else {
                status = 'dentro da m√©dia';
                alertType = 'info';
            }
            
            display.innerHTML = `
                <p>O consumo deste m√™s foi de <strong>${consumo} m¬≥</strong>.</p>
                <p>A m√©dia hist√≥rica √© de <strong>${avgConsumption.toFixed(1)} m¬≥</strong>.</p>
                <p>Isso √© <strong>${Math.abs(percentageChange).toFixed(1)}%</strong> ${status} em compara√ß√£o com a m√©dia hist√≥rica.</p>
                <div class="alert alert-${alertType}">
                    ${status === 'muito alto' ? 'üö® Aten√ß√£o: Consumo an√¥malo detectado! Verifique poss√≠veis vazamentos.' :
                       status === 'acima da m√©dia' ? '‚ö†Ô∏è O consumo est√° um pouco acima do seu padr√£o. Fique atento!' :
                       status === 'abaixo da m√©dia' ? '‚úÖ √ìtimo trabalho! Seu consumo est√° eficiente.' :
                       '‚ÑπÔ∏è Seu consumo est√° dentro da m√©dia esperada.'}
                </div>
            `;
        }

        function checkAndDisplayRecommendations() {
            const consumption = data.readings.leituraAtual - data.readings.leituraAnterior;
            const recommendationCard = document.getElementById('recommendation-card');
            const recommendationsList = document.getElementById('recommendations-list');
            recommendationsList.innerHTML = '';
            
            const tips = [
                "Feche a torneira ao escovar os dentes e fazer a barba. Uma torneira aberta gasta at√© 12 litros por minuto!",
                "Reduza o tempo do banho. Um banho de 5 minutos pode economizar at√© 100 litros de √°gua.",
                "Conserte vazamentos em torneiras e vasos sanit√°rios. Um gotejamento constante pode desperdi√ßar 45 litros de √°gua por dia.",
                "Use a m√°quina de lavar lou√ßa e a de lavar roupa com a carga m√°xima. Isso reduz o n√∫mero de ciclos e economiza √°gua e energia.",
                "N√£o use a mangueira para limpar cal√ßadas e p√°tios. Use uma vassoura para varrer a sujeira e a poeira."
            ];

            if (consumption > 35) {
                recommendationCard.style.display = 'block';
                recommendationsList.innerHTML += `<div class="recommendation-item"><h4>Seu consumo est√° alto. Considere:</h4></div>`;
                tips.forEach(tip => {
                    recommendationsList.innerHTML += `<div class="recommendation-item">üí° ${tip}</div>`;
                });
            } else if (consumption > 25) {
                recommendationCard.style.display = 'block';
                recommendationsList.innerHTML += `<div class="recommendation-item"><h4>Seu consumo √© moderado. Pequenas a√ß√µes podem ajudar a economizar:</h4></div>`;
                recommendationsList.innerHTML += `<div class="recommendation-item">üí° ${tips[0]}</div>`;
                recommendationsList.innerHTML += `<div class="recommendation-item">üí° ${tips[1]}</div>`;
                recommendationsList.innerHTML += `<div class="recommendation-item">üí° ${tips[2]}</div>`;
            } else {
                recommendationCard.style.display = 'none';
            }
        }
        
        function displayDailyReadingsTable() {
            const tbody = document.getElementById('daily-readings-table');
            tbody.innerHTML = '';
            if (data.dailyReadings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="empty-state">Nenhuma leitura di√°ria salva.</td></tr>';
                return;
            }
            data.dailyReadings.forEach((reading, index) => {
                const row = `
                    <tr>
                        <td>${reading.date}</td>
                        <td>${reading.reading} m¬≥</td>
                        <td><button class="btn danger" onclick="removeDailyReading(${index})">Remover</button></td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }
        
        function displayMonthlyReadingsTable() {
            const tbody = document.getElementById('monthly-readings-table');
            tbody.innerHTML = '';
            if (data.monthlyReadings.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="4" class="empty-state">Nenhuma leitura mensal salva.</td></tr>';
                return;
            }
            data.monthlyReadings.forEach((reading, index) => {
                const previousReading = data.monthlyReadings[index + 1] ? data.monthlyReadings[index + 1].reading : data.readings.leituraAnterior;
                const consumo = reading.reading - previousReading;
                const row = `
                    <tr>
                        <td>${reading.date}</td>
                        <td>${reading.reading} m¬≥</td>
                        <td>${consumo > 0 ? consumo : '-'} m¬≥</td>
                        <td><button class="btn danger" onclick="removeMonthlyReading(${index})">Remover</button></td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }
        
        function displayConsumptionHistoryTable() {
            const tbody = document.getElementById('history-table');
            tbody.innerHTML = '';
            if (data.consumptionHistory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="empty-state">Nenhum hist√≥rico de consumo salvo.</td></tr>';
                return;
            }
            data.consumptionHistory.forEach(item => {
                const row = `
                    <tr>
                        <td>${item.mes}</td>
                        <td>${item.consumo} m¬≥</td>
                        <td>R$ ${item.valor.toFixed(2)}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function toggleAccordion(sectionId) {
            const content = document.getElementById(sectionId + 'Content');
            const header = content.previousElementSibling;
            
            document.querySelectorAll('.accordion-content').forEach(item => {
                if (item.id !== content.id) {
                    item.style.display = 'none';
                    item.previousElementSibling.classList.remove('active');
                }
            });

            if (content.style.display === "flex") {
                content.style.display = "none";
                header.classList.remove('active');
            } else {
                content.style.display = "flex";
                header.classList.add('active');
            }
        }
        
        function clearFields(section) {
            if (section === 'company') {
                document.getElementById('company-nome').value = '';
                document.getElementById('company-endereco').value = '';
                document.getElementById('company-cnpj').value = '';
                data.companyInfo = { nome: "", endereco: "", cnpj: "" };
            } else if (section === 'client') {
                document.getElementById('client-nome').value = '';
                document.getElementById('client-matricula').value = '';
                document.getElementById('client-endereco').value = '';
                data.clientInfo = { nome: "", matricula: "", endereco: "" };
            } else if (section === 'billing') {
                document.getElementById('valor-agua').value = '';
                document.getElementById('juros').value = '';
                document.getElementById('total-pagar').value = '';
                data.billing = { valorAgua: 0, juros: 0, totalPagar: 0 };
            }
            saveData();
            updateDisplay();
        }

        function addDailyReading() {
            const input = document.getElementById('daily-reading-input');
            const reading = parseInt(input.value);
            if (!reading || isNaN(reading)) {
                showAlert('danger', 'Por favor, insira uma leitura v√°lida.');
                return;
            }
            
            let previousReading = data.readings.leituraAtual;
            if (data.dailyReadings.length > 0) {
                 previousReading = data.dailyReadings[data.dailyReadings.length - 1].reading;
            }

            if (reading < previousReading) {
                showAlert('danger', 'Erro: A leitura atual n√£o pode ser menor que a anterior.');
                return;
            }
            
            const dailyConsumption = reading - previousReading;
            if (dailyConsumption > 2 && data.dailyReadings.length > 0) {
                showAlert('warning', `‚ö†Ô∏è Consumo di√°rio elevado (${dailyConsumption} m¬≥). Fique atento, pode ser um vazamento!`);
            }

            const today = new Date().toLocaleDateString('pt-BR');
            data.dailyReadings.push({ date: today, reading: reading });
            input.value = '';
            saveData();
            displayDailyReadingsTable();
            showAlert('success', 'Leitura di√°ria salva!');
        }
        
        function removeDailyReading(index) {
            data.dailyReadings.splice(index, 1);
            saveData();
            displayDailyReadingsTable();
            showAlert('info', 'Leitura di√°ria removida.');
        }

        function clearDailyReadings() {
            data.dailyReadings = [];
            saveData();
            displayDailyReadingsTable();
            showAlert('warning', 'Leituras di√°rias limpas.');
        }
        
        function saveMonthlyReading() {
            if (data.dailyReadings.length === 0) {
                showAlert('warning', 'Nenhuma leitura di√°ria para salvar como mensal.');
                return;
            }
            const lastReading = data.dailyReadings[data.dailyReadings.length - 1].reading;
            const today = new Date();
            const monthYear = `${(today.getMonth() + 1).toString().padStart(2, '0')}/${today.getFullYear()}`;
            
            const existingMonthlyIndex = data.monthlyReadings.findIndex(r => r.date === monthYear);
            if (existingMonthlyIndex !== -1) {
                data.monthlyReadings[existingMonthlyIndex].reading = lastReading;
            } else {
                data.monthlyReadings.unshift({ date: monthYear, reading: lastReading });
            }
            
            const consumo = lastReading - data.readings.leituraAnterior;
            const valor = data.billing.totalPagar;
            
            const historyIndex = data.consumptionHistory.findIndex(h => h.mes === monthYear);
            if(historyIndex !== -1) {
                 data.consumptionHistory[historyIndex] = { mes: monthYear, consumo: consumo, valor: valor };
            } else {
                data.consumptionHistory.unshift({ mes: monthYear, consumo: consumo, valor: valor });
            }

            data.readings.leituraAnterior = data.readings.leituraAtual;
            data.readings.leituraAtual = lastReading;
            
            clearDailyReadings();
            saveData();
            updateDisplay();
            showAlert('success', 'Leitura mensal salva e hist√≥rico atualizado!');
        }
        
        function removeMonthlyReading(index) {
            data.monthlyReadings.splice(index, 1);
            saveData();
            displayMonthlyReadingsTable();
            showAlert('info', 'Leitura mensal removida.');
        }
        
        function resetSystem() {
            if (confirm('Tem certeza que deseja limpar todos os dados? Esta a√ß√£o √© irrevers√≠vel.')) {
                data = {
                    companyInfo: { nome: "", endereco: "", cnpj: "" },
                    clientInfo: { nome: "", matricula: "", endereco: "" },
                    readings: { leituraAnterior: 0, leituraAtual: 0 },
                    billing: { valorAgua: 0, juros: 0, totalPagar: 0 },
                    dailyReadings: [],
                    monthlyReadings: [],
                    consumptionHistory: []
                };
                saveData();
                updateDisplay();
                showAlert('danger', 'Todos os dados foram limpos.');
            }
        }
        
        function generatePDF() {
            if (!window.jsPDF || !window.jspdf.jsPDF) {
                showAlert('danger', 'Erro: Biblioteca jsPDF n√£o carregada. Tente novamente.');
                return;
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const margin = 20;
            let y = margin;
            const lineHeight = 10;
            
            doc.setFontSize(22);
            doc.text("Relat√≥rio de Consumo AquaIA", 105, y, { align: "center" });
            y += lineHeight * 2;
            
            doc.setFontSize(14);
            doc.text("Informa√ß√µes da Concession√°ria", margin, y);
            y += lineHeight;
            doc.setFontSize(12);
            doc.text(`Nome: ${data.companyInfo.nome}`, margin, y);
            y += lineHeight;
            doc.text(`Endere√ßo: ${data.companyInfo.endereco}`, margin, y);
            y += lineHeight;
            doc.text(`CNPJ: ${data.companyInfo.cnpj}`, margin, y);
            y += lineHeight * 2;
            
            doc.setFontSize(14);
            doc.text("Dados do Cliente", margin, y);
            y += lineHeight;
            doc.setFontSize(12);
            doc.text(`Nome: ${data.clientInfo.nome}`, margin, y);
            y += lineHeight;
            doc.text(`Matr√≠cula: ${data.clientInfo.matricula}`, margin, y);
            y += lineHeight;
            doc.text(`Endere√ßo: ${data.clientInfo.endereco}`, margin, y);
            y += lineHeight * 2;
            
            doc.setFontSize(14);
            doc.text("Detalhes da Fatura", margin, y);
            y += lineHeight;
            doc.setFontSize(12);
            doc.text(`Leitura Anterior: ${data.readings.leituraAnterior} m¬≥`, margin, y);
            y += lineHeight;
            doc.text(`Leitura Atual: ${data.readings.leituraAtual} m¬≥`, margin, y);
            y += lineHeight;
            const consumo = data.readings.leituraAtual - data.readings.leituraAnterior;
            doc.text(`Consumo: ${consumo} m¬≥`, margin, y);
            y += lineHeight * 2;
            
            doc.setFontSize(14);
            doc.text("Discrimina√ß√£o de Valores", margin, y);
            y += lineHeight;
            doc.setFontSize(12);
            doc.text(`Valor da √Ågua: R$ ${data.billing.valorAgua.toFixed(2)}`, margin, y);
            y += lineHeight;
            doc.text(`Juros: R$ ${data.billing.juros.toFixed(2)}`, margin, y);
            y += lineHeight;
            doc.text(`Total a Pagar: R$ ${data.billing.totalPagar.toFixed(2)}`, margin, y);
            y += lineHeight * 2;
            
            doc.setFontSize(14);
            doc.text("Hist√≥rico de Consumo", margin, y);
            y += lineHeight;

            const historyData = data.consumptionHistory.map(item => [item.mes, `${item.consumo} m¬≥`, `R$ ${item.valor.toFixed(2)}`]);
            
            doc.autoTable({
                startY: y,
                head: [['M√™s', 'Consumo (m¬≥)', 'Valor (R$)']],
                body: historyData,
                theme: 'striped',
                headStyles: { fillColor: [102, 126, 234], textColor: [255, 255, 255] },
                margin: { left: margin, right: margin }
            });

            doc.save("relatorio_agua.pdf");
            showAlert('success', 'Documento PDF gerado e baixado!');
        }
        
        function exportData() {
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'aquaia_data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            showAlert('info', 'Dados exportados como JSON.');
        }

        function showAlert(type, message) {
            const container = document.getElementById('alerts-container');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            container.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 5000);
        }

        // OCR com Tesseract.js
        document.getElementById('ocr-upload').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('ocr-preview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    processOCR(file);
                };
                reader.readAsDataURL(file);
            }
        });

        async function processOCR(imageFile) {
            showAlert('info', 'ü§ñ Analisando a imagem com Tesseract.js...');
            try {
                const { data: { text } } = await Tesseract.recognize(
                    imageFile,
                    'por',
                    { logger: m => console.log(m) } // Opcional: para ver o progresso no console
                );
                
                const extractedData = parseOCRText(text);
                
                if (extractedData.leituraAnterior && extractedData.leituraAtual) {
                    data.readings.leituraAnterior = extractedData.leituraAnterior;
                    data.readings.leituraAtual = extractedData.leituraAtual;
                }
                
                if (extractedData.valorAgua) {
                    data.billing.valorAgua = extractedData.valorAgua;
                    document.getElementById('valor-agua').value = data.billing.valorAgua;
                }
                if (extractedData.totalPagar) {
                    data.billing.totalPagar = extractedData.totalPagar;
                    document.getElementById('total-pagar').value = data.billing.totalPagar;
                }

                saveData();
                updateDisplay();
                showAlert('success', '‚úÖ Dados da fatura preenchidos automaticamente com sucesso!');

            } catch (error) {
                console.error('OCR Error:', error);
                showAlert('danger', '‚ùå Erro ao processar a imagem. Tente uma imagem mais clara.');
            }
        }

        function parseOCRText(text) {
            const result = {};
            const lines = text.split('\n');

            // Regex para valores de consumo (n√∫meros inteiros de 3-4 d√≠gitos)
            const leituraRegex = /(?:LEITURA|CONSUMO)\s*(?:ATUAL|ANTERIOR)?\s*(\d{3,4})\s*M3/i;
            const leiturasEncontradas = text.matchAll(leituraRegex);
            const leituras = [...leiturasEncontradas].map(m => parseInt(m[1]));
            if (leituras.length >= 2) {
                // Assume que o primeiro √© a leitura atual e o segundo a anterior
                result.leituraAtual = leituras[0];
                result.leituraAnterior = leituras[1];
            }

            // Regex para valores em R$
            const valorAguaRegex = /VALOR DO AGUA\s*R\$?\s*(\d+,\d{2})/i;
            const totalPagarRegex = /TOTAL A PAGAR\s*R\$?\s*(\d+,\d{2})/i;

            const valorAguaMatch = text.match(valorAguaRegex);
            const totalPagarMatch = text.match(totalPagarRegex);

            if (valorAguaMatch && valorAguaMatch[1]) {
                result.valorAgua = parseFloat(valorAguaMatch[1].replace(',', '.'));
            }
            if (totalPagarMatch && totalPagarMatch[1]) {
                result.totalPagar = parseFloat(totalPagarMatch[1].replace(',', '.'));
            }

            return result;
        }

        function createConsumptionChart() {
            const ctx = document.getElementById('consumptionChart').getContext('2d');
            
            const reversedHistory = [...data.consumptionHistory].reverse();
            const avgConsumption = data.consumptionHistory.length > 0 ? data.consumptionHistory.reduce((sum, item) => sum + item.consumo, 0) / data.consumptionHistory.length : 0;

            const labels = reversedHistory.map(item => item.mes);
            const consumoData = reversedHistory.map(item => item.consumo);
            const valorData = reversedHistory.map(item => item.valor);
            const avgData = reversedHistory.map(() => avgConsumption.toFixed(1));

            if (consumptionChart) {
                consumptionChart.destroy();
            }

            consumptionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Consumo (m¬≥)',
                            data: consumoData,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.2)',
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y',
                        },
                        {
                            label: 'Valor (R$)',
                            data: valorData,
                            borderColor: '#2ecc71',
                            backgroundColor: 'rgba(46, 204, 113, 0.2)',
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y1',
                        },
                        {
                            label: 'M√©dia Hist√≥rica',
                            data: avgData,
                            borderColor: '#e74c3c',
                            borderDash: [5, 5],
                            pointStyle: false,
                            fill: false,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Consumo (m¬≥)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Valor (R$)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        },
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        if (context.dataset.label.includes('Consumo')) {
                                            label += context.parsed.y + ' m¬≥';
                                        } else if (context.dataset.label.includes('Valor')) {
                                            label += 'R$ ' + context.parsed.y.toFixed(2);
                                        } else {
                                            label += context.parsed.y;
                                        }
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', loadData);

    </script>
</body>
</html>
